---
- name: Add user 
  user: 
    name: "{{ user_name }}" 
    groups: sudo,audio
    append: yes 
    shell: /bin/bash 
    password: "{{ user_password | password_hash('sha512') }}"  

- name: Allow user to run sudo without password
  lineinfile:
    path: /etc/sudoers.d/{{ user_name }}
    create: yes
    owner: root
    group: root
    mode: '0440'
    line: '{{ user_name }} ALL=(ALL) NOPASSWD: ALL'
    validate: /usr/sbin/visudo -cf %s

- name: Update Package Cache
  tags: always
  apt:
    update_cache: yes

- name: Install all packages
  package:
    name:
      - bspwm
      - vim
      - rsync
      - rofi
      - xsecurelock
      - polybar
      - feh
      - imagemagick
      - picom
      - x11-xkb-utils
      - xfce4-terminal
      - slim
      - qjackctl
      - xserver-xorg
      - xserver-xorg-core
      - firefox-esr
      - chromium
      - fonts-jetbrains-mono
      - pavucontrol
      - flameshot
      - pulseaudio-module-jack
      - sxhkd
      - alttab
      - gimp
      - audacity
      - krita
      - iptables
      - htop
      - openvpn
      - ifupdown
      - dnsmasq
      - apt-transport-https
      - ca-certificates
      - curl
      - gpg
      - freecad
      - blender
      - thunderbird
      - gerbv
      - gvfs-backends
      - kdenlive
      - qemu-kvm
      - libvirt-daemon-system-systemd
      - libvirt-clients
      - bridge-utils
      - virtinst
      - libvirt-daemon
      - virt-manager
      - ssh-askpass
      - resolvconf
      - vlc
      - cups
      - libwebkit2gtk-4.1-0
      - python3.13-venv
      - ardour
      - rakarack
    state: latest
  tags:
    - install_packages

- name: Repo configure
  block:
    - name: Reset main sources.list to managed state
      copy:
        content: "# Managed by Ansible â€” see /etc/apt/sources.list.d/\n"
        dest: /etc/apt/sources.list
        mode: '0644'
      become: yes
    
    - name: Configure base Debian 13 (trixie) repository
      apt_repository:
        repo: "deb http://deb.debian.org/debian/ trixie main non-free-firmware"
        filename: debian-trixie
        state: present
      become: yes
    
    - name: Configure trixie source packages
      apt_repository:
        repo: "deb-src http://deb.debian.org/debian/ trixie main non-free-firmware"
        filename: debian-trixie-src
        state: present
      become: yes
    
    - name: Configure Debian security updates
      apt_repository:
        repo: "deb http://security.debian.org/debian-security trixie-security main non-free-firmware"
        filename: debian-security
        state: present
      become: yes
    
    - name: Configure Debian security source packages
      apt_repository:
        repo: "deb-src http://security.debian.org/debian-security trixie-security main non-free-firmware"
        filename: debian-security-src
        state: present
      become: yes
    
    - name: Configure trixie-updates
      apt_repository:
        repo: "deb http://deb.debian.org/debian/ trixie-updates main non-free-firmware"
        filename: debian-updates
        state: present
      become: yes
    
    - name: Configure trixie-updates source packages
      apt_repository:
        repo: "deb-src http://deb.debian.org/debian/ trixie-updates main non-free-firmware"
        filename: debian-updates-src
        state: present
      become: yes
  tags:
    - repos

- name: Download Orca
  get_url:
    url: 'https://github.com/OrcaSlicer/OrcaSlicer/releases/download/v2.3.1/OrcaSlicer_Linux_AppImage_Ubuntu2404_V2.3.1.AppImage'
    dest: /opt/orca.AppImage
    mode: '0777'
  become: yes

- name: Download winbox
  get_url:
    url: 'https://download.mikrotik.com/routeros/winbox/3.43/winbox64.exe'
    dest: /opt/winbox.exe
    mode: '0777'
  become: yes

- name: Docker install
  block:
    - name: Download ASCII-armored GPG key
      get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /tmp/docker.asc
        mode: '0600'
      become: yes
    
    - name: Convert to binary and place in trusted.gpg.d
      command:
        cmd: gpg --dearmor -o /etc/apt/trusted.gpg.d/docker.gpg /tmp/docker.asc
        creates: /etc/apt/trusted.gpg.d/docker.gpg
      become: yes
    
    - name: Add Docker APT repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
        state: present
        filename: docker

    - name: Install Docker packages
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Ensure docker service is started and enabled
      service:
        name: docker
        state: started
        enabled: yes

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ user_name }}"
        groups: docker
        append: yes

- name: dnsmasq configure
  copy:
    src: dnsmasq.conf
    dest: "/etc/dnsmasq.conf"
    owner: "root"
    group: "root"
    mode: 0644

- name: dnsmasq
  service:
    name: dnsmasq
    state: restarted
    enabled: yes

- name: Ensure /etc/resolv.conf uses 127.0.0.1
  ansible.builtin.copy:
    content: "nameserver 127.0.0.1\n"
    dest: /etc/resolv.conf
    mode: '0644'

- name: Add dns-nameservers to /etc/network/interfaces (if exists)
  ansible.builtin.lineinfile:
    path: /etc/network/interfaces
    line: "dns-nameservers 127.0.0.1"
    insertafter: EOF

- name: Install Telegram Desktop
  block:
    - name: Download Telegram
      get_url:
        url: https://telegram.org/dl/desktop/linux
        dest: /tmp/telegram.tar.xz
        mode: '0644'

    - name: Extract Telegram
      unarchive:
        src: /tmp/telegram.tar.xz
        dest: /opt/
        creates: /opt/Telegram/Telegram
        remote_src: yes

    - name: Create symlink
      file:
        src: /opt/Telegram/Telegram
        dest: /usr/local/bin/telegram
        state: link

- name: Install nekoray
  block:
    - name: Download nekoray
      get_url:
        url: https://github.com/MatsuriDayo/nekoray/releases/download/4.0.1/nekoray-4.0.1-2024-12-12-debian-x64.deb
        dest: /tmp/nekoray.deb
        mode: '0644'

    - name: Local install nekoray
      apt:
        deb: /tmp/nekoray.deb


- name: Install dependency opentablet dotnet
  block:
    - name: Download dotnet deb repo
      get_url:
        url: https://packages.microsoft.com/config/debian/13/packages-microsoft-prod.deb
        dest: /tmp/dotnetrepo.deb
        mode: '0775'

    - name: Local install dotnetrepo
      apt:
        deb: /tmp/dotnetrepo.deb

- name: Install opentablet
  block:
    - name: Download opentablet
      get_url:
        url: https://github.com/OpenTabletDriver/OpenTabletDriver/releases/latest/download/opentabletdriver-0.6.6.2-1-x64.deb
        dest: /tmp/opentablet.deb
        mode: '0775'

    - name: Local install opentablet
      apt:
        deb: /tmp/opentablet.deb
        update_cache: true

- name: Install rutoken
  block:
    - name: Download rutoken
      get_url:
        url: https://download.rutoken.ru/Rutoken/PKCS11Lib/2.18.1.0/Linux/x64/librtpkcs11ecp_2.18.1.0-1_amd64.deb
        dest: /tmp/rutoken.deb
        mode: '0775'

    - name: Local install rutoken
      apt:
        deb: /tmp/rutoken.deb

- name: Install wine
  block:
    - name: Enable i386 architecture for Wine
      command:
        cmd: dpkg --add-architecture i386
      become: yes

    - name: Download WineHQ GPG key (ASCII format)
      ansible.builtin.get_url:
        url: https://dl.winehq.org/wine-builds/winehq.key
        dest: /tmp/winehq.key
        mode: '0600'
      become: yes
    
    - name: Convert to binary GPG key without TTY
      ansible.builtin.command:
        cmd: gpg --batch --yes --dearmor -o /etc/apt/keyrings/winehq-archive.key /tmp/winehq.key

    - name: Wine repo add
      shell: |
        wget -NP /etc/apt/sources.list.d/ https://dl.winehq.org/wine-builds/debian/dists/trixie/winehq-trixie.sources

    - name: Install Wine (stable)
      apt:
        name:
          - winehq-stable
        state: present
        update_cache: yes

- name: Install steam
  block:
    - name: Add Steam GPG key
      get_url:
        url: https://repo.steampowered.com/steam/archive/stable/steam.gpg
        dest: /etc/apt/trusted.gpg.d/steam.gpg
        mode: '0644'
      
    - name: Add Steam APT repository
      apt_repository:
        repo: "deb [arch=amd64,i386] https://repo.steampowered.com/steam/ stable steam"
        filename: steam-stable
        state: present
    
    - name: Install Steam launcher and 32-bit OpenGL dependencies
      apt:
        name:
          - steam-launcher
          - libgl1-mesa-dri:amd64
          - libgl1-mesa-dri:i386
        state: present
        update_cache: yes
  tags:
    - steam

- name: Install ONLYOFFICE Desktop Editors on Debian
  become: yes
  block:
    - name: Ensure ~/.gnupg directory exists for gpg
      file:
        path: "{{ ansible_user_dir }}/.gnupg"
        state: directory
        mode: '0700'
    
    - name: Fetch ONLYOFFICE GPG key via keyserver
      command:
        cmd: gpg --no-default-keyring --keyring gnupg-ring:/tmp/onlyoffice.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys CB2DE8E5
        creates: /tmp/onlyoffice.gpg
    
    - name: Copy ONLYOFFICE GPG key to /usr/share/keyrings/ (from remote src)
      copy:
        src: /tmp/onlyoffice.gpg
        dest: /usr/share/keyrings/onlyoffice.gpg
        remote_src: yes
        owner: root
        group: root
        mode: '0644'

    - name: Remove temporary GPG key file
      file:
        path: /tmp/onlyoffice.gpg
        state: absent
    
    - name: Add ONLYOFFICE APT repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/onlyoffice.gpg] https://download.onlyoffice.com/repo/debian squeeze main"
        filename: onlyoffice
        state: present
    
    - name: Install ONLYOFFICE Desktop Editors
      apt:
        name: onlyoffice-desktopeditors
        state: present
        update_cache: yes
  tags:
    - onlyoffice



- name: Create directory to config
  file:
    path: "/home/{{ user_name }}/{{ item }}"
    state: directory
    mode: 0755
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
  loop:
    - '.config'
    - '.config/bspwm'
    - '.config/polybar'
    - '.config/sxhkd'
    - '.scripts'
    - '.config/xfce4'
    - '.config/xfce4/terminal'
    - 'images'

- name: Xorg keyboard config
  become: yes
  template:
    src: 00-keyboard.conf.j2
    dest: /etc/X11/xorg.conf.d/00-keyboard.conf
    mode: 0644

- name: desktop images install
  copy:
    src: image.jpg
    dest: "/home/{{ user_name }}/images/fon.jpg"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: 0755

- name: copy discord sh script
  copy:
    src: discord.sh
    dest: "/home/{{ user_name }}/discord.sh"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: 0777

- name: copy float script
  copy:
    src: workfloat.sh
    dest: "/home/{{ user_name }}/.scripts/workfloat.sh"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: 0777

- name: default display manager config install
  copy:
    dest: /etc/X11/default-display-manager
    content: /usr/bin/slim
    owner: root
    group: root
    mode: 0755

- name: sxhkdrc config install
  copy:
    src: sxhkdrc
    dest: "/home/{{ user_name }}/.config/sxhkd/sxhkdrc"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: 0755

- name: vim config install
  copy:
    src: vimrc
    dest: "/home/{{ user_name }}/.vimrc"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: 0755

- name: bspwm config install 1 monitor
  copy:
    src: bspwmrc_one
    dest: "/home/{{ user_name }}/.config/bspwm/bspwmrc"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: 0775
  when: count_monitor == "1"

- name: bspwm config install 2 monitors
  copy:
    src: bspwmrc
    dest: "/home/{{ user_name }}/.config/bspwm/bspwmrc"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: 0775
  when: count_monitor == "2"

- name: polybar config install 1 monitor
  copy:
    src: polybarconfig_one
    dest: "/home/{{ user_name }}/.config/polybar/config"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: 0755
  when: count_monitor == "1"

- name: polybar config install 2 monitors
  copy:
    src: polybarconfig
    dest: "/home/{{ user_name }}/.config/polybar/config"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: 0755
  when: count_monitor == "2"

- name: Xresources config install
  copy:
    src: Xresources
    dest: "/home/{{ user_name }}/.Xresources"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: 0755

- name: bashrc config install
  copy:
    src: bashrc
    dest: "/home/{{ user_name }}/.bashrc"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: 0755

- name: bashrc config install
  copy:
    src: bashrc
    dest: "/home/{{ user_name }}/.bashrc"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: 0755

- name: xfce4terminalaccess config install
  copy:
    src: xfce4terminalaccels.scm
    dest: "/home/{{ user_name }}/.config/xfce4/terminal/accels.scm"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: 0755

- name: xfce4terminalrc config install
  copy:
    src: xfce4terminalrc
    dest: "/home/{{ user_name }}/.config/xfce4/terminal/terminalrc"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: 0755

- name: slim enable start
  service:
    name: slim
    state: started
    enabled: yes
...
